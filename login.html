<html>
<head>
    <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.24.0/js/msal-browser.min.js"></script>
</head>
<body>

<button id="login">login</button>
<button id="logout">logout</button>
<div id="welcome"></div>
<div id="info"></div>

<script type="module">
  const msalConfig = {
    auth: {
      clientId: '83a36355-ad17-4ed0-8701-e99a3020f86a',
      authority: 'https://login.microsoftonline.com/common',
      // redirectUri: 'http://localhost:3000/login.html',
    },
    cache: {
      cacheLocation: "sessionStorage",
      storeAuthStateInCookie: false,
    },
    system: {
      loggerOptions: {
        loggerCallback: (level, message, containsPii) => {
          if (containsPii) {
            return;
          }
          switch (level) {
            case msal.LogLevel.Error:
              console.error(message);
              return;
            case msal.LogLevel.Info:
              console.info(message);
              return;
            case msal.LogLevel.Verbose:
              console.debug(message);
              return;
            case msal.LogLevel.Warning:
              console.warn(message);
              return;
          }
        }
      }
    }
  };

  /**
   * Scopes you add here will be prompted for user consent during sign-in.
   * By default, MSAL.js will add OIDC scopes (openid, profile, email) to any login request.
   * For more information about OIDC scopes, visit:
   * https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-permissions-and-consent#openid-connect-scopes
   */
  const loginRequest = {
    scopes: ["User.Read"]
  };

  /**
   * Add here the scopes to request when obtaining an access token for MS Graph API. For more information, see:
   * https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/resources-and-scopes.md
   */
  const tokenRequest = {
    scopes: ["User.Read", "Mail.Read"],
    forceRefresh: false // Set this to "true" to skip a cached token and go to the server to get a new token
  };


  const ms = new msal.PublicClientApplication(msalConfig);

  let username = "";

  function showWelcomeMessage(account) {
    document.getElementById('info').innerText = JSON.stringify(account, null, 2);
    document.getElementById('welcome').innerText = `Welcome: ${account.name} <${account.username}>`;
  }

  /**
   * A promise handler needs to be registered for handling the
   * response returned from redirect flow. For more information, visit:
   * https://github.com/AzureAD/microsoft-authentication-library-for-js/blob/dev/lib/msal-browser/docs/acquire-token.md
   */

  ms.handleRedirectPromise()
    .then(handleResponse)
    .catch((error) => {
      console.error(error);
    });

  function selectAccount () {
    const currentAccounts = ms.getAllAccounts();
    if (currentAccounts.length === 0) {
      return;
    } else if (currentAccounts.length > 1) {
      // Add your account choosing logic here
      console.warn("Multiple accounts detected.");
    } else if (currentAccounts.length === 1) {
      username = currentAccounts[0].username;
      showWelcomeMessage(currentAccounts[0]);
    }
  }

  function handleResponse(response) {
    console.log('response', response);
    if (response !== null) {
      username = response.account.username;
      showWelcomeMessage(response.account);
    } else {
      selectAccount();
    }
  }

  function signIn() {
    ms.loginRedirect(loginRequest);
  }

  async function signOut() {
    const logoutRequest = {
      account: ms.getAccountByUsername(username),
      postLogoutRedirectUri: msalConfig.auth.redirectUri,
      onRedirectNavigate: (url) => {
        // Return false if you would like to stop navigation after local logout
        return false;
      }
    };
    await ms.logoutRedirect(logoutRequest);
  }

  function getTokenRedirect(request) {
    request.account = ms.getAccountByUsername(username);
    return ms.acquireTokenSilent(request)
      .catch(error => {
        console.warn("silent token acquisition fails. acquiring token using redirect");
        if (error instanceof msal.InteractionRequiredAuthError) {
          // fallback to interaction when silent call fails
          return ms.acquireTokenRedirect(request);
        } else {
          console.warn(error);
        }
      });
  }

  function seeProfile() {
    getTokenRedirect(loginRequest)
      .then(response => {
        callMSGraph(graphConfig.graphMeEndpoint, response.accessToken, updateUI);
      }).catch(error => {
      console.error(error);
    });
  }

  function readMail() {
    getTokenRedirect(tokenRequest)
      .then(response => {
        callMSGraph(graphConfig.graphMailEndpoint, response.accessToken, updateUI);
      }).catch(error => {
      console.error(error);
    });
  }

  ms.addEventCallback((message) => {
    // Update UI or interact with EventMessage here
    if (message.eventType === msal.EventType.LOGOUT_SUCCESS) {
      console.log(message.payload);
      window.location.reload();
    }
  });

  document.getElementById('login').onclick = signIn;
  document.getElementById('logout').onclick = signOut;
</script>
</body>
</html>
